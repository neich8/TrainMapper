// var request = require("request")
var parseString = require('xml2js').parseString;
var routes = "rt=red,blue,g,brn,p,y,pink,org"
var locations = "http://lapi.transitchicago.com/api/1.0/ttpositions.aspx?key=" + train_key +  "&" + routes
var TrainLocations = require("../models/TrainLocation")
var fakeLocations = '<?xml version="1.0" encoding="utf-8"?><ctatt><tmst>20160319 17:07:00</tmst><errCd>0</errCd><errNm /><route name="red"><train><rn>812</rn><destSt>30173</destSt><destNm>Howard</destNm><trDr>1</trDr><nextStaId>40560</nextStaId><nextStpId>30109</nextStpId><nextStaNm>Jackson</nextStaNm><prdt>20160319 17:06:02</prdt><arrT>20160319 17:07:02</arrT><isApp>1</isApp><isDly>0</isDly><flags /><lat>41.87404</lat><lon>-87.62748</lon><heading>0</heading></train><train><rn>814</rn><destSt>30089</destSt><destNm>95th/Dan Ryan</destNm><trDr>5</trDr><nextStaId>41170</nextStaId><nextStpId>30224</nextStpId><nextStaNm>Garfield</nextStaNm><prdt>20160319 17:06:20</prdt><arrT>20160319 17:08:20</arrT><isApp>0</isApp><isDly>0</isDly><flags /><lat>41.80928</lat><lon>-87.63159</lon><heading>197</heading></train><train><rn>815</rn><destSt>30089</destSt><destNm>95th/Dan Ryan</destNm><trDr>5</trDr><nextStaId>40650</nextStaId><nextStpId>30126</nextStpId><nextStaNm>North/Clybourn</nextStaNm><prdt>20160319 17:06:36</prdt><arrT>20160319 17:07:36</arrT><isApp>1</isApp><isDly>0</isDly><flags /><lat>41.91336</lat><lon>-87.65249</lon><heading>179</heading></train><train><rn>816</rn><destSt>30089</destSt><destNm>95th/Dan Ryan</destNm><trDr>5</trDr><nextStaId>41220</nextStaId><nextStpId>30234</nextStpId><nextStaNm>Fullerton</nextStaNm><prdt>20160319 17:06:22</prdt><arrT>20160319 17:12:22</arrT><isApp>0</isApp><isDly>0</isDly><flags /><lat>41.93739</lat><lon>-87.65332</lon><heading>177</heading></train><train><rn>817</rn><destSt>30089</destSt><destNm>95th/Dan Ryan</destNm><trDr>5</trDr><nextStaId>40760</nextStaId><nextStpId>30148</nextStpId><nextStaNm>Granville</nextStaNm><prdt>20160319 17:06:06</prdt><arrT>20160319 17:11:06</arrT><isApp>0</isApp><isDly>0</isDly><flags /><lat>42.00107</lat><lon>-87.66106</lon><heading>129</heading></train><train><rn>818</rn><destSt>30173</destSt><destNm>Howard</destNm><trDr>1</trDr><nextStaId>40630</nextStaId><nextStpId>30121</nextStpId><nextStaNm>Clark/Division</nextStaNm><prdt>20160319 17:06:30</prdt><arrT>20160319 17:07:30</arrT><isApp>1</isApp><isDly>0</isDly><flags /><lat>41.90164</lat><lon>-87.62833</lon><heading>358</heading></train><train><rn>820</rn><destSt>30089</destSt><destNm>95th/Dan Ryan</destNm><trDr>5</trDr><nextStaId>41230</nextStaId><nextStpId>30238</nextStpId><nextStaNm>47th</nextStaNm><prdt>20160319 17:06:20</prdt><arrT>20160319 17:07:20</arrT><isApp>1</isApp><isDly>0</isDly><flags /><lat>41.8248</lat><lon>-87.63049</lon><heading>178</heading></train><train><rn>823</rn><destSt>30173</destSt><destNm>Howard</destNm><trDr>1</trDr><nextStaId>41220</nextStaId><nextStpId>30233</nextStpId><nextStaNm>Fullerton</nextStaNm><prdt>20160319 17:06:33</prdt><arrT>20160319 17:07:33</arrT><isApp>1</isApp><isDly>0</isDly><flags /><lat>41.91773</lat><lon>-87.65263</lon><heading>358</heading></train><train><rn>824</rn><destSt>30173</destSt><destNm>Howard</destNm><trDr>1</trDr><nextStaId>40190</nextStaId><nextStpId>30036</nextStpId><nextStaNm>Sox-35th</nextStaNm><prdt>20160319 17:06:10</prdt><arrT>20160319 17:08:10</arrT><isApp>0</isApp><isDly>0</isDly><flags /><lat>41.81036</lat><lon>-87.63101</lon><heading>32</heading></train><train><rn>825</rn><destSt>30173</destSt><destNm>Howard</destNm><trDr>1</trDr><nextStaId>40240</nextStaId><nextStpId>30046</nextStpId><nextStaNm>79th</nextStaNm><prdt>20160319 17:06:05</prdt><arrT>20160319 17:08:05</arrT><isApp>0</isApp><isDly>0</isDly><flags /><lat>41.73537</lat><lon>-87.62475</lon><heading>357</heading></train><train><rn>826</rn><destSt>30089</destSt><destNm>95th/Dan Ryan</destNm><trDr>5</trDr><nextStaId>40340</nextStaId><nextStpId>30067</nextStpId><nextStaNm>Berwyn</nextStaNm><prdt>20160319 17:05:33</prdt><arrT>20160319 17:06:33</arrT><isApp>1</isApp><isDly>0</isDly><flags /><lat>41.98074</lat><lon>-87.65876</lon><heading>178</heading></train><train><rn>908</rn><destSt>30089</destSt><destNm>95th/Dan Ryan</destNm><trDr>5</trDr><nextStaId>41660</nextStaId><nextStpId>30290</nextStpId><nextStaNm>Lake</nextStaNm><prdt>20160319 17:06:21</prdt><arrT>20160319 17:08:21</arrT><isApp>0</isApp><isDly>0</isDly><flags /><lat>41.89166</lat><lon>-87.62802</lon><heading>178</heading></train><train><rn>909</rn><destSt>30089</destSt><destNm>95th/Dan Ryan</destNm><trDr>5</trDr><nextStaId>40080</nextStaId><nextStpId>30017</nextStpId><nextStaNm>Sheridan</nextStaNm><prdt>20160319 17:06:23</prdt><arrT>20160319 17:07:23</arrT><isApp>1</isApp><isDly>0</isDly><flags /><lat>41.95462</lat><lon>-87.65675</lon><heading>176</heading></train><train><rn>910</rn><destSt>30173</destSt><destNm>Howard</destNm><trDr>1</trDr><nextStaId>41320</nextStaId><nextStpId>30255</nextStpId><nextStaNm>Belmont</nextStaNm><prdt>20160319 17:06:30</prdt><arrT>20160319 17:07:30</arrT><isApp>1</isApp><isDly>0</isDly><flags /><lat>41.93584</lat><lon>-87.65326</lon><heading>357</heading></train><train><rn>916</rn><destSt>30089</destSt><destNm>95th/Dan Ryan</destNm><trDr>5</trDr><nextStaId>41230</nextStaId><nextStpId>30238</nextStpId><nextStaNm>47th</nextStaNm><prdt>20160319 17:06:38</prdt><arrT>20160319 17:08:38</arrT><isApp>0</isApp><isDly>0</isDly><flags /><lat>41.83119</lat><lon>-87.63064</lon><heading>178</heading></train><train><rn>917</rn><destSt>30089</destSt><destNm>95th/Dan Ryan</destNm><trDr>5</trDr><nextStaId>41090</nextStaId><nextStpId>30212</nextStpId><nextStaNm>Monroe</nextStaNm><prdt>20160319 17:05:56</prdt><arrT>20160319 17:06:56</arrT><isApp>1</isApp><isDly>0</isDly><flags /><lat>41.88481</lat><lon>-87.62781</lon><heading>178</heading></train><train><rn>918</rn><destSt>30089</destSt><destNm>95th/Dan Ryan</destNm><trDr>5</trDr><nextStaId>40880</nextStaId><nextStpId>30170</nextStpId><nextStaNm>Thorndale</nextStaNm><prdt>20160319 17:06:29</prdt><arrT>20160319 17:07:29</arrT><isApp>1</isApp><isDly>0</isDly><flags /><lat>41.99196</lat><lon>-87.65912</lon><heading>178</heading></train><train><rn>919</rn><destSt>30173</destSt><destNm>Howard</destNm><trDr>1</trDr><nextStaId>40910</nextStaId><nextStpId>30177</nextStpId><nextStaNm>63rd</nextStaNm><prdt>20160319 17:06:27</prdt><arrT>20160319 17:07:27</arrT><isApp>1</isApp><isDly>0</isDly><flags /><lat>41.77498</lat><lon>-87.6271</lon><heading>321</heading></train></route><route name="blue"><train><rn>113</rn><destSt>30171</destSt><destNm>O_Hare</destNm><trDr>1</trDr><nextStaId>40890</nextStaId><nextStpId>30171</nextStpId><nextStaNm>O_Hare</nextStaNm><prdt>20160319 17:06:26</prdt><arrT>20160319 17:09:26</arrT><isApp>0</isApp><isDly>0</isDly><flags /><lat>41.98341</lat><lon>-87.86224</lon><heading>268</heading></train><train><rn>115</rn><destSt>30171</destSt><destNm>O_Hare</destNm><trDr>1</trDr><nextStaId>41330</nextStaId><nextStpId>30259</nextStpId><nextStaNm>Montrose</nextStaNm><prdt>20160319 17:06:33</prdt><arrT>20160319 17:07:33</arrT><isApp>1</isApp><isDly>0</isDly><flags /><lat>41.95799</lat><lon>-87.73824</lon><heading>299</heading></train><train><rn>116</rn><destSt>30171</destSt><destNm>O_Hare</destNm><trDr>1</trDr><nextStaId>40320</nextStaId><nextStpId>30062</nextStpId><nextStaNm>Division</nextStaNm><prdt>20160319 17:05:47</prdt><arrT>20160319 17:07:47</arrT><isApp>0</isApp><isDly>0</isDly><flags /><lat>41.89608</lat><lon>-87.65521</lon><heading>301</heading></train><train><rn>117</rn><destSt>30171</destSt><destNm>O_Hare</destNm><trDr>1</trDr><nextStaId>40570</nextStaId><nextStpId>30111</nextStpId><nextStaNm>California</nextStaNm><prdt>20160319 17:06:25</prdt><arrT>20160319 17:08:25</arrT><isApp>0</isApp><isDly>0</isDly><flags /><lat>41.91616</lat><lon>-87.68736</lon><heading>302</heading></train><train><rn>126</rn><destSt>30171</destSt><destNm>O_Hare</destNm><trDr>1</trDr><nextStaId>40470</nextStaId><nextStpId>30092</nextStpId><nextStaNm>Racine</nextStaNm><prdt>20160319 17:06:38</prdt><arrT>20160319 17:07:38</arrT><isApp>1</isApp><isDly>0</isDly><flags /><lat>41.87587</lat><lon>-87.66053</lon><heading>89</heading></train><train><rn>127</rn><destSt>30171</destSt><destNm>O_Hare</destNm><trDr>1</trDr><nextStaId>40970</nextStaId><nextStpId>30187</nextStpId><nextStaNm>Cicero</nextStaNm><prdt>20160319 17:06:39</prdt><arrT>20160319 17:07:39</arrT><isApp>1</isApp><isDly>0</isDly><flags /><lat>41.87008</lat><lon>-87.76318</lon><heading>83</heading></train><train><rn>130</rn><destSt>30077</destSt><destNm>Forest Park</destNm><trDr>5</trDr><nextStaId>40470</nextStaId><nextStpId>30093</nextStpId><nextStaNm>Racine</nextStaNm><prdt>20160319 17:06:34</prdt><arrT>20160319 17:07:34</arrT><isApp>1</isApp><isDly>0</isDly><flags /><lat>41.8759</lat><lon>-87.65823</lon><heading>269</heading></train><train><rn>131</rn><destSt>30077</destSt><destNm>Forest Park</destNm><trDr>5</trDr><nextStaId>40320</nextStaId><nextStpId>30063</nextStpId><nextStaNm>Division</nextStaNm><prdt>20160319 17:06:39</prdt><arrT>20160319 17:07:39</arrT><isApp>1</isApp><isDly>0</isDly><flags /><lat>41.90486</lat><lon>-87.66948</lon><heading>113</heading></train><train><rn>132</rn><destSt>30077</destSt><destNm>Forest Park</destNm><trDr>5</trDr><nextStaId>40060</nextStaId><nextStpId>30013</nextStpId><nextStaNm>Belmont</nextStaNm><prdt>20160319 17:06:27</prdt><arrT>20160319 17:10:27</arrT><isApp>0</isApp><isDly>0</isDly><flags /><lat>41.9526</lat><lon>-87.72857</lon><heading>119</heading></train><train><rn>214</rn><destSt>30077</destSt><destNm>Forest Park</destNm><trDr>5</trDr><nextStaId>40010</nextStaId><nextStpId>30002</nextStpId><nextStaNm>Austin</nextStaNm><prdt>20160319 17:06:36</prdt><arrT>20160319 17:08:36</arrT><isApp>0</isApp><isDly>0</isDly><flags /><lat>41.8715</lat><lon>-87.75395</lon><heading>269</heading></train><train><rn>215</rn><destSt>30077</destSt><destNm>Forest Park</destNm><trDr>1</trDr><nextStaId>40060</nextStaId><nextStpId>30012</nextStpId><nextStaNm>Belmont</nextStaNm><prdt>20160319 17:06:27</prdt><arrT>20160319 17:08:27</arrT><isApp>0</isApp><isDly>0</isDly><flags /><lat>41.94735</lat><lon>-87.71909</lon><heading>310</heading></train></route><route name="g"><train><rn>009</rn><destSt>30004</destSt><destNm>Harlem/Lake</destNm><trDr>1</trDr><nextStaId>41260</nextStaId><nextStpId>30244</nextStpId><nextStaNm>Austin</nextStaNm><prdt>20160319 17:05:54</prdt><arrT>20160319 17:06:54</arrT><isApp>1</isApp><isDly>0</isDly><flags /><lat>41.88739</lat><lon>-87.76565</lon><heading>269</heading></train><train><rn>013</rn><destSt>30004</destSt><destNm>Harlem/Lake</destNm><trDr>1</trDr><nextStaId>41690</nextStaId><nextStpId>30381</nextStpId><nextStaNm>Cermak-McCormick Place</nextStaNm><prdt>20160319 17:06:32</prdt><arrT>20160319 17:07:32</arrT><isApp>1</isApp><isDly>0</isDly><flags /><lat>0</lat><lon>0</lon><heading>90</heading></train><train><rn>015</rn><destSt>30057</destSt><destNm>Ashland/63rd</destNm><trDr>5</trDr><nextStaId>41080</nextStaId><nextStpId>30210</nextStpId><nextStaNm>47th</nextStaNm><prdt>20160319 17:05:02</prdt><arrT>20160319 17:06:02</arrT><isApp>1</isApp><isDly>0</isDly><flags /><lat>41.81284</lat><lon>-87.61892</lon><heading>178</heading></train><train><rn>016</rn><destSt>30139</destSt><destNm>Cottage Grove</destNm><trDr>5</trDr><nextStaId>41120</nextStaId><nextStpId>30214</nextStpId><nextStaNm>35th-Bronzeville-IIT</nextStaNm><prdt>20160319 17:06:08</prdt><arrT>20160319 17:09:08</arrT><isApp>0</isApp><isDly>0</isDly><flags /><lat>41.83168</lat><lon>-87.62588</lon><heading>178</heading></train><train><rn>017</rn><destSt>30057</destSt><destNm>Ashland/63rd</destNm><trDr>5</trDr><nextStaId>40260</nextStaId><nextStpId>30050</nextStpId><nextStaNm>State/Lake</nextStaNm><prdt>20160319 17:05:59</prdt><arrT>20160319 17:06:59</arrT><isApp>1</isApp><isDly>0</isDly><flags /><lat>41.88574</lat><lon>-87.63089</lon><heading>89</heading></train><train><rn>018</rn><destSt>30139</destSt><destNm>Cottage Grove</destNm><trDr>5</trDr><nextStaId>40170</nextStaId><nextStpId>30033</nextStpId><nextStaNm>Ashland</nextStaNm><prdt>20160319 17:05:52</prdt><arrT>20160319 17:08:52</arrT><isApp>0</isApp><isDly>0</isDly><flags /><lat>41.88422</lat><lon>-87.69623</lon><heading>88</heading></train><train><rn>609</rn><destSt>30004</destSt><destNm>Harlem/Lake</destNm><trDr>1</trDr><nextStaId>40380</nextStaId><nextStpId>30075</nextStpId><nextStaNm>Clark/Lake</nextStaNm><prdt>20160319 17:06:35</prdt><arrT>20160319 17:07:35</arrT><isApp>1</isApp><isDly>0</isDly><flags /><lat>41.88574</lat><lon>-87.62783</lon><heading>270</heading></train><train><rn>610</rn><destSt>30004</destSt><destNm>Harlem/Lake</destNm><trDr>1</trDr><nextStaId>40130</nextStaId><nextStpId>30024</nextStpId><nextStaNm>51st</nextStaNm><prdt>20160319 17:05:48</prdt><arrT>20160319 17:07:48</arrT><isApp>0</isApp><isDly>0</isDly><flags /><lat>41.79517</lat><lon>-87.61832</lon><heading>358</heading></train><train><rn>613</rn><destSt>30057</destSt><destNm>Ashland/63rd</destNm><trDr>5</trDr><nextStaId>40700</nextStaId><nextStpId>30135</nextStpId><nextStaNm>Laramie</nextStaNm><prdt>20160319 17:06:30</prdt><arrT>20160319 17:07:30</arrT><isApp>1</isApp><isDly>0</isDly><flags /><lat>41.88747</lat><lon>-87.75852</lon><heading>89</heading></train><train><rn>615</rn><destSt>30004</destSt><destNm>Harlem/Lake</destNm><trDr>1</trDr><nextStaId>41670</nextStaId><nextStpId>30292</nextStpId><nextStaNm>Conservatory-Central Park Drive</nextStaNm><prdt>20160319 17:06:26</prdt><arrT>20160319 17:07:26</arrT><isApp>1</isApp><isDly>0</isDly><flags /><lat>41.88432</lat><lon>-87.70615</lon><heading>273</heading></train></route><route name="brn"><train><rn>413</rn><destSt>30249</destSt><destNm>Kimball</destNm><trDr>1</trDr><nextStaId>41480</nextStaId><nextStpId>30283</nextStpId><nextStaNm>Western</nextStaNm><prdt>20160319 17:06:14</prdt><arrT>20160319 17:08:14</arrT><isApp>0</isApp><isDly>0</isDly><flags /><lat>41.96641</lat><lon>-87.67864</lon><heading>269</heading></train><train><rn>417</rn><destSt>30249</destSt><destNm>Kimball</destNm><trDr>1</trDr><nextStaId>40800</nextStaId><nextStpId>30155</nextStpId><nextStaNm>Sedgwick</nextStaNm><prdt>20160319 17:06:00</prdt><arrT>20160319 17:08:00</arrT><isApp>0</isApp><isDly>0</isDly><flags /><lat>41.90108</lat><lon>-87.6367</lon><heading>355</heading></train><train><rn>419</rn><destSt>30249</destSt><destNm>Kimball</destNm><trDr>1</trDr><nextStaId>40200</nextStaId><nextStpId>30038</nextStpId><nextStaNm>Randolph/Wabash</nextStaNm><prdt>20160319 17:06:35</prdt><arrT>20160319 17:07:35</arrT><isApp>1</isApp><isDly>0</isDly><flags /><lat>41.8832</lat><lon>-87.62619</lon><heading>358</heading></train><train><rn>420</rn><destSt>30249</destSt><destNm>Loop</destNm><trDr>5</trDr><nextStaId>41210</nextStaId><nextStpId>30232</nextStpId><nextStaNm>Wellington</nextStaNm><prdt>20160319 17:06:37</prdt><arrT>20160319 17:08:37</arrT><isApp>0</isApp><isDly>0</isDly><flags /><lat>41.94391</lat><lon>-87.65807</lon><heading>89</heading></train><train><rn>421</rn><destSt>30249</destSt><destNm>Kimball</destNm><trDr>1</trDr><nextStaId>41310</nextStaId><nextStpId>30253</nextStpId><nextStaNm>Paulina</nextStaNm><prdt>20160319 17:06:21</prdt><arrT>20160319 17:07:21</arrT><isApp>1</isApp><isDly>0</isDly><flags /><lat>41.94377</lat><lon>-87.66726</lon><heading>269</heading></train><train><rn>422</rn><destSt>30249</destSt><destNm>Kimball</destNm><trDr>1</trDr><nextStaId>41220</nextStaId><nextStpId>30235</nextStpId><nextStaNm>Fullerton</nextStaNm><prdt>20160319 17:05:46</prdt><arrT>20160319 17:07:46</arrT><isApp>0</isApp><isDly>0</isDly><flags /><lat>41.91822</lat><lon>-87.65264</lon><heading>358</heading></train><train><rn>423</rn><destSt>30249</destSt><destNm>Kimball</destNm><trDr>1</trDr><nextStaId>40730</nextStaId><nextStpId>30142</nextStpId><nextStaNm>Washington/Wells</nextStaNm><prdt>20160319 17:05:55</prdt><arrT>20160319 17:06:55</arrT><isApp>1</isApp><isDly>0</isDly><flags /><lat>41.88583</lat><lon>-87.63392</lon><heading>178</heading></train><train><rn>424</rn><destSt>30249</destSt><destNm>Loop</destNm><trDr>5</trDr><nextStaId>40710</nextStaId><nextStpId>30138</nextStpId><nextStaNm>Chicago</nextStaNm><prdt>20160319 17:06:06</prdt><arrT>20160319 17:09:06</arrT><isApp>0</isApp><isDly>0</isDly><flags /><lat>41.91041</lat><lon>-87.6393</lon><heading>89</heading></train><train><rn>425</rn><destSt>30249</destSt><destNm>Loop</destNm><trDr>5</trDr><nextStaId>40660</nextStaId><nextStpId>30128</nextStpId><nextStaNm>Armitage</nextStaNm><prdt>20160319 17:06:36</prdt><arrT>20160319 17:08:36</arrT><isApp>0</isApp><isDly>0</isDly><flags /><lat>41.92505</lat><lon>-87.65287</lon><heading>178</heading></train><train><rn>426</rn><destSt>30249</destSt><destNm>Loop</destNm><trDr>5</trDr><nextStaId>41500</nextStaId><nextStpId>30288</nextStpId><nextStaNm>Montrose</nextStaNm><prdt>20160319 17:06:17</prdt><arrT>20160319 17:07:17</arrT><isApp>1</isApp><isDly>0</isDly><flags /><lat>41.96641</lat><lon>-87.67864</lon><heading>89</heading></train></route><route name="p"><train><rn>504</rn><destSt>30203</destSt><destNm>Linden</destNm><trDr>1</trDr><nextStaId>41250</nextStaId><nextStpId>30241</nextStpId><nextStaNm>Central</nextStaNm><prdt>20160319 17:01:57</prdt><arrT>20160319 17:02:57</arrT><isApp>1</isApp><isDly>1</isDly><flags /><lat>42.06397</lat><lon>-87.68561</lon><heading>328</heading></train><train><rn>507</rn><destSt>30203</destSt><destNm>Linden</destNm><trDr>1</trDr><nextStaId>40270</nextStaId><nextStpId>30052</nextStpId><nextStaNm>Main</nextStaNm><prdt>20160319 17:06:37</prdt><arrT>20160319 17:07:37</arrT><isApp>1</isApp><isDly>0</isDly><flags /><lat>42.03054</lat><lon>-87.6789</lon><heading>347</heading></train></route><route name="y"><train><rn>593</rn><destSt>30176</destSt><destNm>Skokie</destNm><trDr>1</trDr><nextStaId>40140</nextStaId><nextStpId>30026</nextStpId><nextStaNm>Dempster-Skokie</nextStaNm><prdt>20160319 17:06:24</prdt><arrT>20160319 17:07:24</arrT><isApp>1</isApp><isDly>0</isDly><flags /><lat>42.03568</lat><lon>-87.75048</lon><heading>154</heading></train><train><rn>594</rn><destSt>30176</destSt><destNm>Howard</destNm><trDr>5</trDr><nextStaId>40900</nextStaId><nextStpId>30176</nextStpId><nextStaNm>Howard</nextStaNm><prdt>20160319 17:06:21</prdt><arrT>20160319 17:08:21</arrT><isApp>0</isApp><isDly>0</isDly><flags /><lat>0</lat><lon>0</lon><heading>90</heading></train></route><route name="pink"><train><rn>308</rn><destSt>30114</destSt><destNm>54th/Cermak</destNm><trDr>5</trDr><nextStaId>40440</nextStaId><nextStpId>30087</nextStpId><nextStaNm>California</nextStaNm><prdt>20160319 17:06:34</prdt><arrT>20160319 17:07:34</arrT><isApp>1</isApp><isDly>0</isDly><flags /><lat>41.85439</lat><lon>-87.68775</lon><heading>269</heading></train><train><rn>310</rn><destSt>30114</destSt><destNm>54th/Cermak</destNm><trDr>1</trDr><nextStaId>41160</nextStaId><nextStpId>30222</nextStpId><nextStaNm>Clinton</nextStaNm><prdt>20160319 17:06:32</prdt><arrT>20160319 17:07:32</arrT><isApp>1</isApp><isDly>0</isDly><flags /><lat>41.88572</lat><lon>-87.63614</lon><heading>269</heading></train><train><rn>311</rn><destSt>30114</destSt><destNm>Loop</destNm><trDr>5</trDr><nextStaId>41160</nextStaId><nextStpId>30221</nextStpId><nextStaNm>Clinton</nextStaNm><prdt>20160319 17:06:12</prdt><arrT>20160319 17:07:12</arrT><isApp>1</isApp><isDly>0</isDly><flags /><lat>41.88558</lat><lon>-87.65219</lon><heading>89</heading></train><train><rn>314</rn><destSt>30114</destSt><destNm>Loop</destNm><trDr>1</trDr><nextStaId>41030</nextStaId><nextStpId>30199</nextStpId><nextStaNm>Polk</nextStaNm><prdt>20160319 17:06:08</prdt><arrT>20160319 17:08:08</arrT><isApp>0</isApp><isDly>0</isDly><flags /><lat>41.85791</lat><lon>-87.66916</lon><heading>358</heading></train><train><rn>315</rn><destSt>30114</destSt><destNm>Loop</destNm><trDr>1</trDr><nextStaId>40600</nextStaId><nextStpId>30117</nextStpId><nextStaNm>Kostner</nextStaNm><prdt>20160319 17:06:32</prdt><arrT>20160319 17:08:32</arrT><isApp>0</isApp><isDly>0</isDly><flags /><lat>41.85192</lat><lon>-87.74534</lon><heading>89</heading></train></route><route name="org"><train><rn>708</rn><destSt>30182</destSt><destNm>Midway</destNm><trDr>5</trDr><nextStaId>40310</nextStaId><nextStpId>30061</nextStpId><nextStaNm>Western</nextStaNm><prdt>20160319 17:06:08</prdt><arrT>20160319 17:10:08</arrT><isApp>0</isApp><isDly>0</isDly><flags /><lat>41.82949</lat><lon>-87.6807</lon><heading>239</heading></train><train><rn>710</rn><destSt>30182</destSt><destNm>Midway</destNm><trDr>5</trDr><nextStaId>40160</nextStaId><nextStpId>30031</nextStpId><nextStaNm>LaSalle/Van Buren</nextStaNm><prdt>20160319 17:06:24</prdt><arrT>20160319 17:07:24</arrT><isApp>1</isApp><isDly>0</isDly><flags /><lat>41.87691</lat><lon>-87.6282</lon><heading>267</heading></train><train><rn>711</rn><destSt>30182</destSt><destNm>Loop</destNm><trDr>1</trDr><nextStaId>40120</nextStaId><nextStpId>30022</nextStpId><nextStaNm>35th/Archer</nextStaNm><prdt>20160319 17:06:29</prdt><arrT>20160319 17:09:29</arrT><isApp>0</isApp><isDly>0</isDly><flags /><lat>41.80617</lat><lon>-87.67969</lon><heading>19</heading></train><train><rn>713</rn><destSt>30182</destSt><destNm>Midway</destNm><trDr>5</trDr><nextStaId>40930</nextStaId><nextStpId>30182</nextStpId><nextStaNm>Midway</nextStaNm><prdt>20160319 17:02:17</prdt><arrT>20160319 17:03:17</arrT><isApp>1</isApp><isDly>1</isDly><flags /><lat>41.79788</lat><lon>-87.72957</lon><heading>248</heading></train><train><rn>715</rn><destSt>30182</destSt><destNm>Midway</destNm><trDr>5</trDr><nextStaId>40200</nextStaId><nextStpId>30039</nextStpId><nextStaNm>Randolph/Wabash</nextStaNm><prdt>20160319 17:06:39</prdt><arrT>20160319 17:07:39</arrT><isApp>1</isApp><isDly>0</isDly><flags /><lat>41.88443</lat><lon>-87.62622</lon><heading>178</heading></train><train><rn>716</rn><destSt>30182</destSt><destNm>Midway</destNm><trDr>5</trDr><nextStaId>40960</nextStaId><nextStpId>30186</nextStpId><nextStaNm>Pulaski</nextStaNm><prdt>20160319 17:06:36</prdt><arrT>20160319 17:07:36</arrT><isApp>1</isApp><isDly>0</isDly><flags /><lat>41.80138</lat><lon>-87.72105</lon><heading>246</heading></train><train><rn>717</rn><destSt>30182</destSt><destNm>Midway</destNm><trDr>5</trDr><nextStaId>41130</nextStaId><nextStpId>30216</nextStpId><nextStaNm>Halsted</nextStaNm><prdt>20160319 17:06:05</prdt><arrT>20160319 17:11:05</arrT><isApp>0</isApp><isDly>0</isDly><flags /><lat>41.86744</lat><lon>-87.62659</lon><heading>177</heading></train><train><rn>718</rn><destSt>30182</destSt><destNm>Loop</destNm><trDr>1</trDr><nextStaId>41130</nextStaId><nextStpId>30215</nextStpId><nextStaNm>Halsted</nextStaNm><prdt>20160319 17:06:36</prdt><arrT>20160319 17:07:36</arrT><isApp>1</isApp><isDly>0</isDly><flags /><lat>41.8413</lat><lon>-87.66123</lon><heading>64</heading></train></route></ctatt>'

function request(locations, cb) {
  cb(null, null, fakeLocations)
};

getLocations = function(cb) {
  request(locations, function(err, response, body) {
    if(err) {
      cb(null, err)
    } else {
      parseXML(body.toString(), function(err, result) {
        if(err) {
          cb({}, err)
        } else {
          var filtered_result = result.CTATT
          var timeStamp = cleanDate(filtered_result.TMST[0])
          var lines = filtered_result.ROUTE
          trains = []
          for(var i = 0; i < lines.length -1; i++ ) {
            trainLine = lines[0]
            route = trainLine["$"]["NAME"]
            for(var num = 0; num < trainLine.TRAIN.length; num++) {
              train = trainLine.TRAIN[num]
              trains.push({
                route: route,
                rn: train.RN[0],
                lat: train.LAT[0],
                lng: train.LON[0],
                direction: train.DESTNM[0],
                timeStamp: timeStamp,
                nextStop: train.NEXTSTPID[0],
                arrivalTime: cleanDate(train.ARRT[0])
              });
            }
          }
          cb(trains)
        }
      }); 

    }
  })
}

function cleanDate(date) {
  return date.slice(0,4) + "-" + date.slice(5,6) + "-" + date.slice(6,(date.length + 1))
}

parseXML = function(string, cb) {
  parseString(string, {
  tagNameProcessors: [nameToUpperCase],
  attrNameProcessors: [nameToUpperCase],
  valueProcessors: [nameToUpperCase],
  attrValueProcessors: [nameToUpperCase]},
  function (err, result) {
    if(err) {
      console.log(err, null);
      cb(err)
    } else {
      cb(null, result)
    }
  });
}

function nameToUpperCase(name){
    return name.toUpperCase();
}


module.exports = getLocations